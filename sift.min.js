/*
 * Sift
 * 
 * Copryright 2011, Craig Condon
 * Licensed under MIT
 *
 * Inspired by mongodb's query language 
 */(function(){var a=function(a,b){var c={},d=c;for(var e=0,f=a.length-1;e<f;e++)d=d[a[e]]={};return d[a[e]]=b,c},b=new function(){function e(a){return a instanceof Date?a.getTime():a}var b=this.test=function(a,b){var c=a.exprs;for(var d=0,f=c.length;d<f;d++){var g=c[d];if(!g.e(g.v,e(b),b))return!1}return!0},c=this.parse=function(e,g){var i=[];if(e)if(e.constructor==Object)for(var j in e){var k=f[j]?j:"$trav",l=e[j],m=l;if(d[k]){if(j.indexOf(".")>-1){var n=j.split(".");j=n.shift(),l=a(n,l)}if(l instanceof Array){m=[];for(var o=l.length;o--;)m.push(c(l[o]))}else m=c(e[j],j)}i.push(h(k,j,m))}else i.push(h("$eq",j,e));var p={exprs:i,k:g,test:function(a){return b(p,a)}};return p},d={$and:!0,$or:!0,$nor:!0,$trav:!0,$not:!0},f={$eq:function(a,b){return a.test(b)},$ne:function(a,b){return!a.test(b)},$lt:function(a,b){return a>b},$gt:function(a,b){return a<b},$lte:function(a,b){return a>=b},$gte:function(a,b){return a<=b},$exists:function(a,b){return a==!!b},$in:function(a,b){if(!(b instanceof Array))return a.indexOf(b)>-1;for(var c=b.length;c--;)if(a.indexOf(b[c])>-1)return!0},$not:function(a,b){return!a.test(b)},$type:function(a,b,c){return c?c instanceof a||c.constructor==a:!1},$nin:function(a,b){return!f.$in(a,b)},$mod:function(a,b){return b%a[0]==a[1]},$all:function(a,b){for(var c=a.length;c--;){var d=a[c];if(b.indexOf(d)==-1)return!1}return!0},$size:function(a,b){return b?a==b.length:!1},$or:function(a,c){var d=a.length,e=d;for(;d--;)if(b(a[d],c))return!0;return!e},$nor:function(a,c){var d=a.length,e=d;for(;d--;)if(!b(a[d],c))return!0;return!e},$and:function(a,c){for(var d=a.length;d--;)if(!b(a[d],c))return!1;return!0},$trav:function(a,c){if(c instanceof Array){for(var d=c.length;d--;){var e=c[d];if(e[a.k]&&b(a,e[a.k]))return!0}return!1}return c?b(a,c[a.k]):!1}},g={$eq:function(a){var b;return a instanceof RegExp?a:(a instanceof Function?b=a:b=function(b){return b instanceof Array?!!~b.indexOf(a):a==b},{test:b})},$ne:function(a){return g.$eq(a)}},h=function(a,b,c){var d=e(c);return{k:b,v:g[a]?g[a](d):d,e:f[a]}}},c=function(a){var c=b.parse(a),d=function(a){var b=[];for(var d=0,e=a.length;d<e;d++)c.test(a[d])&&b.push(a[d]);return b};return d.test=c.test,d.query=a,d},d=function(a,b){var d=c(a);return b?d(b):d};typeof module!="undefined"&&typeof module.exports!="undefined"?module.exports=d:typeof window!="undefined"&&(window.sift=d)})();